# TPE QA Analyzer - 需求规格说明书 (SRS)

**项目名称:** TPE QA Analyzer
**版本:** 1.0
**日期:** 2025-08-30
**状态:** Draft
**作者:** [您的姓名/团队]

## 1. 概述

### 1.1 目的
本文档旨在定义 `TPE QA Analyzer` 工具的需求规格。该工具用于对 `Targeted Pressure Executor (TPE)` 生成的 JSON 格式日志文件进行自动化、定量的分析，以评估模型在压力测试下的表现，重点关注角色一致性、稳定性及响应质量。

### 1.2 范围
`TPE QA Analyzer` 是一个独立的命令行工具，其输入是 `TPE` 工具的输出（JSON日志文件）。它不依赖于LLM进行核心分析，而是基于预定义的规则、关键词词典和统计方法来处理数据。其输出为结构化的分析报告。

### 1.3 参考资料
*   `tpe/USAGE.md`: TPE 工具的使用说明。
*   `tpe/logs/tpe_log_*.json`: TPE 工具的典型输出文件格式。

## 2. 总体描述

### 2.1 产品视角
`TPE QA Analyzer` 是 `psy2` 项目压力测试工作流中的下游分析工具。它接收 `TPE` 的输出作为输入，进行量化分析，并生成报告，为研究人员提供客观数据以评估模型能力。

```
[TPE Logs] --> [TPE QA Analyzer] --> [Analysis Reports (CSV/JSON/MD)]
```

### 2.2 产品功能
该工具旨在提供以下核心分析功能：
1.  **角色内识别 (In-Character Identification)**
2.  **角色脱离检测 (Character Break Detection)**
3.  **冲突处理分析 (Conflict Handling Analysis)**
4.  **响应质量评估 (Response Quality Assessment)**
5.  **综合报告生成 (Comprehensive Reporting)**

### 2.3 用户特征
*   AI研究员
*   心理学分析师
*   项目开发与测试人员

### 2.4 运行环境
*   Python 3.7+
*   依赖库: `argparse`, `json`, `csv`, `re`, `collections`, `os`, `pathlib` (可能需要 `nltk` 或 `spaCy` 用于基础 NLP，但不用于 LLM 推理)

## 3. 外部接口需求

### 3.1 用户界面
*   **接口类型**: 命令行界面 (CLI)
*   **主要命令**: `python analyze_tpe_log.py --log_file <path_to_tpe_log.json> [--output_dir <output_directory>]`
*   **输入**:
    *   `--log_file`: (必需) 指向 TPE 生成的 JSON 日志文件的路径。
    *   `--output_dir`: (可选) 指定分析报告的输出目录。默认为 `./analysis_reports`。
    *   `--config`: (可选) 指向配置文件的路径，用于自定义关键词词典等。
*   **输出**: 在指定目录下生成分析报告文件。

### 3.2 通信接口
*   无网络通信接口。所有处理均在本地完成。

## 4. 系统特性

### 4.1 角色内识别 (In-Character Identification) - `[QA-FR-01]`
**描述**: 分析模型响应中与所扮演角色相关的关键词出现频率，评估其角色扮演的沉浸度。

**刺激/响应序列**:
*   **刺激**: 提供一个 `tpe_log_*.json` 文件。
*   **响应**: 
    1.  读取 `role_applied` 字段。
    2.  根据 `role_applied` 查找预定义的角色关键词词典。
    3.  遍历 `execution_results` 中的每个 `model_response`。
    4.  统计每个响应中命中角色关键词的数量和具体词汇。
    5.  计算并输出整体的角色内识别分数。

**功能需求**:
*   **[QA-FR-01-01]** 工具必须能加载与不同角色 (`a1`, `b1`, ...) 关联的关键词词典。
*   **[QA-FR-01-02]** 工具必须能对单个 `model_response` 文本进行关键词匹配。
*   **[QA-FR-01-03]** 工具必须能统计单个响应的命中关键词列表和数量。
*   **[QA-FR-01-04]** 工具必须能基于所有响应的关键词命中情况，计算一个综合的“角色内识别分数”。(例如: `总命中次数 / (总响应字符数或总关键词数)`)
*   **[QA-FR-01-05]** 工具必须将此分析结果包含在最终报告中。

### 4.2 角色脱离检测 (Character Break Detection) - `[QA-FR-02]`
**描述**: 检测模型响应中是否出现了破坏角色扮演的“AI禁语”，评估其在压力下的稳定性。

**刺激/响应序列**:
*   **刺激**: 提供一个 `tpe_log_*.json` 文件。
*   **响应**: 
    1.  加载预定义的全局“AI禁语”列表。
    2.  （可选）加载与 `role_applied` 相关的特定禁语列表。
    3.  遍历 `execution_results` 中的每个 `model_response`。
    4.  检测每个响应中是否包含任何禁语。
    5.  统计出现禁语的响应数量和具体禁语。
    6.  计算并输出“角色脱离风险指数”。

**功能需求**:
*   **[QA-FR-02-01]** 工具必须能加载全局和角色特定的“AI禁语”列表。
*   **[QA-FR-02-02]** 工具必须能对单个 `model_response` 文本进行禁语匹配。
*   **[QA-FR-02-03]** 工具必须能记录每个响应命中的禁语列表和数量。
*   **[QA-FR-02-04]** 工具必须能基于所有响应的禁语命中情况，计算一个综合的“角色脱离风险指数”。(例如: `出现禁语的响应数 / 总响应数`)
*   **[QA-FR-02-05]** 工具必须将此分析结果包含在最终报告中。

### 4.3 冲突处理分析 (Conflict Handling Analysis) - `[QA-FR-03]`
**描述**: 分析模型在面对预设人格冲突时的响应，识别其决策倾向和权衡逻辑。

**刺激/响应序列**:
*   **刺激**: 提供一个 `tpe_log_*.json` 文件。
*   **响应**: 
    1.  加载针对 `pressure_test_bank.json` 中定义的冲突类型的关键词词典。
    2.  遍历 `execution_results`。
    3.  对于每个 `result`，根据其 `targeted_conflict` (如 "Duty vs. Empathy")，加载对应的分析词典。
    4.  在 `model_response` 中统计指向冲突双方的关键词。
    5.  输出每个场景的决策倾向分析和整体倾向统计。

**功能需求**:
*   **[QA-FR-03-01]** 工具必须能加载针对不同 `targeted_conflict` 的关键词分析词典。
*   **[QA-FR-03-02]** 工具必须能根据 `result` 中的 `targeted_conflict` 字段，选择正确的分析词典。
*   **[QA-FR-03-03]** 工具必须能统计单个响应中指向冲突双方的关键词。
*   **[QA-FR-03-04]** 工具应能基于关键词统计，给出一个简单的倾向性判断（如：更偏向A，更偏向B，或相对平衡）。
*   **[QA-FR-03-05]** 工具必须将此分析结果包含在最终报告中。

### 4.4 响应质量评估 (Response Quality Assessment) - `[QA-FR-04]`
**描述**: 通过分析响应的长度、结构和信息量，评估模型输出的质量。

**刺激/响应序列**:
*   **刺激**: 提供一个 `tpe_log_*.json` 文件。
*   **响应**: 
    1.  遍历 `execution_results` 中的每个 `model_response`。
    2.  计算响应的字符数、词数、句子数。
    3.  （可选）识别并计数复杂句式（如包含“因为...所以...”、“然而”等连接词的句子）。
    4.  （可选）识别并计数信息点（如具体的论据、步骤、例子）。
    5.  输出每个响应的质量指标和整体统计。

**功能需求**:
*   **[QA-FR-04-01]** 工具必须能计算单个 `model_response` 的基础文本统计量（字符、词、句）。
*   **[QA-FR-04-02]** (可选) 工具应能识别并计数复杂句式。
*   **[QA-FR-04-03]** (可选) 工具应能识别并计数信息点。
*   **[QA-FR-04-04]** 工具应能基于这些指标，为每个响应输出质量评估数据（注意：当前版本不计算综合分数）。
*   **[QA-FR-04-05]** 工具必须将此分析结果包含在最终报告中。

### 4.5 综合报告生成 (Comprehensive Reporting) - `[QA-FR-05]`
**描述**: 将所有分析结果整合成易于理解的报告格式。

**刺激/响应序列**:
*   **刺激**: 完成对 `tpe_log_*.json` 文件的所有分析。
*   **响应**: 
    1.  汇总所有单项分析的分数和统计数据。
    2.  生成一份综合报告，包含：
        *   测试元数据 (模型、角色、计划文件)
        *   各单项分析的详细结果和得分
        *   整体评估摘要 (雷达图数据点，注意：当前版本不计算总评分)
    3.  将报告以多种格式 (CSV, JSON, Markdown) 保存到指定输出目录。

**功能需求**:
*   **[QA-FR-05-01]** 工具必须能将所有分析结果汇总。
*   **[QA-FR-05-02]** 工具必须能生成 CSV 格式的详细数据表（每行一个场景，每列一个指标）。
*   **[QA-FR-05-03]** 工具必须能生成 JSON 格式的结构化数据报告。
*   **[QA-FR-05-04]** 工具必须能生成 Markdown 格式的易读摘要报告。
*   **[QA-FR-05-05]** 工具必须能将报告文件保存到指定的输出目录。

## 5. 其他非功能性需求

### 5.1 性能需求
*   **[QA-NFR-01]** 分析单个 `tpe_log_*.json` 文件（包含10个场景）应在 5 秒内完成。

### 5.2 可靠性需求
*   **[QA-NFR-02]** 工具应对格式错误的 JSON 输入有良好的错误处理和提示。

### 5.3 可维护性需求
*   **[QA-NFR-03]** 关键词词典和分析规则应易于通过配置文件进行更新和扩展。

### 5.4 可移植性需求
*   **[QA-NFR-04]** 工具应能在 Windows, macOS, Linux 主流操作系统上运行。

## 6. 其他需求

### 6.1 配置文件
工具应支持通过一个 `config.json` 或 `config.yaml` 文件来管理以下内容：
*   全局AI禁语列表。
*   各角色的关键词词典。
*   各冲突类型的分析词典。
*   评分权重（如果用于计算综合分数）。

### 6.2 初始词典/规则
需要为项目中已有的角色（如 `a1`, `b1` 等）和 `pressure_test_bank.json` 中的主要冲突类型，提供初始的关键词词典作为工具的默认配置。